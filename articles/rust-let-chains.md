---
title: "Rust 1.88 ã® let chains æ§‹æ–‡ã«ã¤ã„ã¦"
emoji: "ğŸ·"
type: "tech" # tech: æŠ€è¡“è¨˜äº‹ / idea: ã‚¢ã‚¤ãƒ‡ã‚¢
topics: ["Rust", "æ§‹æ–‡", "ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒ"]
published: false
---

## Let chains æ§‹æ–‡

å…ˆé€± [Rust 1.88](https://blog.rust-lang.org/2025/06/26/Rust-1.88.0/) ãŒãƒªãƒªãƒ¼ã‚¹ã•ã‚Œã¾ã—ãŸã€‚æ™®æ®µã¯ãƒªãƒªãƒ¼ã‚¹ã¸ã®åå¿œè¨˜äº‹ã¯æ›¸ã‹ãªã„ã®ã§ã™ãŒã€ä»Šå›ã¯å‰ã‹ã‚‰æ°—ã«ãªã£ã¦ã„ãŸæ©Ÿèƒ½ãŒå®‰å®šåŒ–ã•ã‚ŒãŸã®ã§å°‘ã—è§¦ã‚Œã¦ãŠããŸã„ã¨æ€ã„ã¾ã™ã€‚

ãã®æ©Ÿèƒ½ã¨ã„ã†ã®ã¯ let chains ã¨å‘¼ã°ã‚Œã¦ã„ã¾ã™ã€‚ã“ã‚Œã¯ä¸€ã¤ã®æ¡ä»¶æ–‡ã« let å¼ã§ãƒãƒƒãƒã™ã‚‹ã¨åŒæ™‚ã« bool å‹ã®æ¡ä»¶ã‚’æ··ãœã‚‹ã“ã¨ãŒã§ãã‚‹æ©Ÿèƒ½ã§ã™ã€‚ä¾‹ãˆã°æ¬¡ã®ã‚ˆã†ã«æ›¸ãã“ã¨ãŒã§ãã¾ã™ã€‚

```rust
fn do_something_over_18(age: Option<i32>) {
    if let Some(age) = age && 18 < age {
        // do something
    }
}
```

ä»¥å‰ã¯æ¬¡ã®ã‚ˆã†ã« if å¼ã‚’ãƒã‚¹ãƒˆã—ã¦æ›¸ãå¿…è¦ãŒã‚ã‚Šã¾ã—ãŸã€‚

```rust
fn do_something_over_18(age: Option<i32>) {
    if let Some(age) = age {
        if 18 < age {
            // do something
        }
    }
}
```

ã“ã‚Œã«ã‚ˆã£ã¦ãƒ–ãƒ­ãƒƒã‚¯ã®ãƒã‚¹ãƒˆã‚’æ¸›ã‚‰ã—ã€ã‚¤ãƒ³ãƒ‡ãƒ³ãƒˆã‚’ä¸è¦ã«æ·±ãã™ã‚‹ã“ã¨ã‚’é¿ã‘ã‚‰ã‚Œã¾ã™ã€‚

æ©Ÿèƒ½è‡ªä½“ã¯ä»¥å‰ã‹ã‚‰ã‚ã‚Šã¾ã—ãŸãŒã€ nightly ã§ feature flag ã‚’æœ‰åŠ¹ã«ã—ãªã„ã¨ä½¿ãˆã¾ã›ã‚“ã§ã—ãŸã€‚ã“ã‚Œã‹ã‚‰ã¯å®‰å®šç‰ˆã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ã‚‚æ°—å…¼ã­ãªãä½¿ã†ã“ã¨ãŒã§ãã¾ã™ã€‚ãŸã ã—ã€ 2021 edition ä»¥å‰ã§ã¯ä½¿ãˆãªã„ã¨ã®ã“ã¨ã§ã™ã€‚ã“ã‚Œã¯ else ç¯€ã®ãƒ©ã‚¤ãƒ•ã‚¿ã‚¤ãƒ ã«é–¢ä¿‚ã—ã¦ã„ã‚‹ã‚ˆã†ã§ã€ 2024 edition ã§çœŸã®åˆ†å²ã«ã®ã¿æ¡ä»¶æ–‡ã«ç¾ã‚Œã‚‹å¤‰æ•°ã®ãƒ©ã‚¤ãƒ•ã‚¿ã‚¤ãƒ ãŒæ‹¡å¼µã•ã‚Œã‚‹ã‚ˆã†ã«ãªã£ãŸã“ã¨ã«ã‚ˆã‚Šå¯èƒ½ã«ãªã£ãŸæ§‹æ–‡ã¨ã®ã“ã¨ã§ã™ã€‚è©³ã—ãã¯å…¬å¼ãƒšãƒ¼ã‚¸ã‹ã‚‰ã®ãƒªãƒ³ã‚¯ã«ã‚‚ã‚ã‚‹[ã“ã¡ã‚‰](https://doc.rust-lang.org/edition-guide/rust-2024/temporary-if-let-scope.html)ã‚’å‚ç…§ã—ã¦ãã ã•ã„ã€‚

ã—ã‹ã—ãªãŒã‚‰ã€ã“ã‚Œã ã‘ã®æ©Ÿèƒ½ãªã‚‰ãã‚Œã»ã©å¤§ããªã‚¤ãƒ³ãƒ‘ã‚¯ãƒˆãŒã‚ã‚‹ã‚‚ã®ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ Rust ã«ã¯è±Šå¯Œãªã‚³ãƒ³ãƒ†ãƒŠå‹ã®ã‚³ãƒ³ãƒ“ãƒãƒ¼ã‚¿ãŒã‚ã‚Šã€ä»¥å‰ã‹ã‚‰æ¬¡ã®ã‚ˆã†ã«æ›¸ãã“ã¨ã‚‚ã§ããŸã‹ã‚‰ã§ã™ã€‚

```rust
fn do_something_over_18(age: Option<i32>) {
    if age.is_some_and(|age| 18 < age) {
        // do something
    }
}
```

å®Ÿéš›ã€ let chains æ§‹æ–‡ã§ã¯è¡¨ç¾ã§ããªã„ `ok_or_else` ã‚„ `map_or` ãªã©ã®ã‚³ãƒ³ãƒ“ãƒãƒ¼ã‚¿ã‚‚ã‚ã‚Šã¾ã™ã®ã§ã€å¾“æ¥ã®æ›¸ãæ–¹ãŒä¸è¦ã«ãªã‚‹ã‚ã‘ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚ãã‚Œã§ã‚‚ã€ã“ã‚Œã‚‰ã®æ•°å¤šãã®ã‚³ãƒ³ãƒ“ãƒãƒ¼ã‚¿ã‚’æš—è¨˜ã—ãªãã¦ã‚‚ç›´æ„Ÿçš„ã«æ›¸ã‘ã‚‹ã¨ã„ã†ã®ã¯åˆ©ç‚¹ã¨è¨€ãˆã¾ã™ã€‚

ã—ã‹ã—ã€çœŸä¾¡ã‚’ç™ºæ®ã™ã‚‹ã®ã¯æ¡ä»¶ã®é–“ã«å€¤ã®ãƒã‚¤ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãŒã§ãã‚‹ç‚¹ã§ã™ã€‚ä¾‹ãˆã°ã€ `Option` å‹ã«åŒ…ã¾ã‚ŒãŸ2æ¬¡å…ƒãƒ™ã‚¯ãƒˆãƒ«ã®è·é›¢ãŒ 10 ä»¥ä¸‹ã§ã‚ã‚‹æ™‚ã«ä½•ã‹ã™ã‚‹ã‚ˆã†ãªã‚³ãƒ¼ãƒ‰ã¯æ¬¡ã®ã‚ˆã†ã«æ›¸ã‘ã¾ã™ã€‚

```rust
fn do_something_if_close(a: Option<Vec2>, b: Option<Vec2>) {
    if let Some((a, b)) = a.zip(b)
        && let dist = (a - b).length()
        && dist < 10.
    {
        // do something
    }
}
```

ã“ã“ã§ `let dist = (a - b).length()` ã¯ãƒãƒƒãƒã«å¿…ãšæˆåŠŸã™ã‚‹ã®ã§ irrefutable ãªãƒ‘ã‚¿ãƒ¼ãƒ³ã¨å‘¼ã°ã‚Œã¾ã™ã€‚ã“ã®ã‚ˆã†ãª irrefutable ãªãƒ‘ã‚¿ãƒ¼ãƒ³ã‚‚æ¡ä»¶å¼ã«æ··ãœã¦æ›¸ãã“ã¨ãŒã§ãã‚‹ã®ãŒæœ€å¤§ã®ç‰¹å¾´ã¨è¨€ãˆã¾ã™ã€‚

`(a - b).length()` ã¯ `Some` ã«ãƒãƒƒãƒã—ãŸå¾Œã«ã—ã‹è¨ˆç®—ã§ãã¾ã›ã‚“ã®ã§ã€å¾“æ¥ã¯æ¬¡ã®ã‚ˆã†ãªæ›¸ãæ–¹ã«ãªã£ã¦ã—ã¾ã„ã¾ã™[^1]ã€‚

[^1]: ã‚‚ã¡ã‚ã‚“ã€ã“ã®ç¨‹åº¦ã®å¼ãªã‚‰ `a.zip(b).is_some_and(|(a, b)| (a - b).length() < 10.)` ã¨æ›¸ã„ã¦ã—ã¾ã†ã¨ã¯æ€ã„ã¾ã™ã€‚ã“ã“ã§ã¯ç°¡å˜ã®ãŸã‚å˜ç´”ãªå¼ã‚’ä¾‹ã«ä½¿ã£ã¦ã„ã¾ã™ãŒã€å®Ÿéš›ã®ã‚³ãƒ¼ãƒ‰ã§ã¯ã‚³ãƒ³ãƒ“ãƒãƒ¼ã‚¿ã§ã¯å¯¾å¿œã§ããªã„ã‚‚ã£ã¨è¤‡é›‘ãªå¼ã®ãƒã‚¹ãƒˆãŒèµ·ãã‚‹ã“ã¨ã‚’æƒ³å®šã—ã¦æ›¸ã„ã¦ã„ã¾ã™ã€‚

```rust
fn do_something_if_close(a: Option<Vec2>, b: Option<Vec2>) {
    if let Some((a, b)) = a.zip(b) {
        let dist = (a - b).length();
        if dist < 10. {
            // do something
        }
    }
}
```

let chains ã®å‰æ®µã§ãƒã‚¤ãƒ³ãƒ‰ã•ã‚ŒãŸå¤‰æ•°ãŒä»¥é™ã®æ¡ä»¶ã«ä½¿ãˆã‚‹ã®ã§ã€ã“ã®ã‚ˆã†ãªä¸­é–“çš„ãªè¨ˆç®—ãŒä»¥é™ã®æ®µã«ä½¿ãˆã¾ã™ã€‚ OCaml ã® `let ... in` æ§‹æ–‡ã‚’å½·å½¿ã¨ã•ã›ã¾ã™ã€‚

## å®Ÿä½¿ç”¨ä¾‹

ã‚‚ã†å°‘ã—å®Ÿéš›ã®ã‚³ãƒ¼ãƒ‰ã«è¿‘ã„ä¾‹ã‚’æŒ™ã’ãŸã„ã¨æ€ã„ã¾ã™ã€‚ä»¥ä¸‹ã®ã‚³ãƒ¼ãƒ‰ã¯å®Ÿéš›ã®ãƒ—ãƒ­ã‚¸ã‚§ã‚¯ãƒˆã§ä½¿ç”¨ã—ã¦ã„ã‚‹ã‚‚ã®ã§ã™ã€‚ã‚„ã‚ŠãŸã„ã“ã¨ã¯å†…å´ã®ãƒ–ãƒ­ãƒƒã‚¯ã®ä¸­ã®ã‚³ãƒ¼ãƒ‰ã‚’æ¡ä»¶ã«å¿œã˜ã¦å®Ÿè¡Œã—ãŸã„ã ã‘ãªã®ã§ã™ãŒã€ãã®æ¡ä»¶ãŒè¤‡é›‘ã™ãã‚‹ãŸã‚ã€ä¸€æ™‚çš„ãªå¤‰æ•° `found_node` ã‚’ä½¿ã£ãŸã‚Šã—ã¦æ¡ä»¶å¼ãŒè¤‡é›‘ã«ãªã‚Šã™ããªã„ã‚ˆã†ã«ã—ã¦ã„ã¾ã™ã€‚ã¾ãŸã€ãƒã‚¹ãƒˆã—ãŸæ¡ä»¶å¼ã®å¤–å´ã®å¤‰æ•°ã‚’å†…å´ã®ãƒ–ãƒ­ãƒƒã‚¯å†…ã§ä½¿ã„ãŸã„ãŸã‚ã€ `and_then` ã®ã‚ˆã†ãªã‚³ãƒ³ãƒ“ãƒãƒ¼ã‚¿ã‚’ä½¿ã£ã¦ä¸€æ®µã® `if` å¼ã«ã™ã‚‹ã“ã¨ãŒã§ãã¾ã›ã‚“ã€‚ãã®çµæœã€ãƒ­ã‚¸ãƒƒã‚¯ãŒä¸€ç›´ç·šã«ãªã‚‰ãšè¦–ç·šã‚’ä¸Šä¸‹ã«æŒ¯ã‚‰ãªã„ã¨å…¨ä½“ãŒæŠŠæ¡ã§ãã¾ã›ã‚“ã€‚

```rust
let found_node = response.hover_pos().and_then(|pointer| {
    let thresh = SELECT_PIXEL_RADIUS / self.transform.scale() as f64;
    self.tracks
        .find_path_node(paint_transform.from_pos2(pointer), thresh)
});
if let Some((path_id, seg_id, _)) = found_node {
    if let Some(path) = self.tracks.paths.get(&path_id) {
        let color = Color32::from_rgba_premultiplied(127, 0, 127, 63);
        let seg_track = path.seg_track(seg_id);
        self.render_track_detail(seg_track, &painter, &paint_transform, 5., color);
    }
}
```

ã“ã‚Œã‚’ let chains æ§‹æ–‡ã§æ›¸ãç›´ã™ã¨æ¬¡ã®ã‚ˆã†ã«ãªã‚Šã¾ã™ã€‚èª­ã¿ã‚„ã™ã„ã‹ã©ã†ã‹ã¯ä¸»è¦³çš„ãªè©•ä¾¡ã«ã¯ãªã‚Šã¾ã™ãŒã€å°‘ãªãã¨ã‚‚æ¡ä»¶å¼ãŒä¸€ã¤ã§ã‚ã‚Šã€ã„ãã¤ã‹ã®ãƒãƒƒãƒã®çµæœãŒã™ã¹ã¦æˆåŠŸã—ãŸæ™‚ã«ãƒ–ãƒ­ãƒƒã‚¯å†…ã‚’å®Ÿè¡Œã—ãŸã„ã¨ã„ã†æ„å›³ã¯ä¸€ç›®ã§ã‚ã‹ã‚Šã¾ã™ã€‚

```rust
if let Some(pointer) = response.hover_pos()
    && let thresh = SELECT_PIXEL_RADIUS / self.transform.scale() as f64
    && let Some((path_id, seg_id, _)) = self
        .tracks
        .find_path_node(paint_transform.from_pos2(pointer), thresh)
    && let Some(path) = self.tracks.paths.get(&path_id)
{
    let color = Color32::from_rgba_premultiplied(127, 0, 127, 63);
    let seg_track = path.seg_track(seg_id);
    self.render_track_detail(seg_track, &painter, &paint_transform, 5., color);
}
```

## C++ ã®æ¡ä»¶å¼ã¨åˆæœŸåŒ–å¼

æ¡ä»¶æ–‡ã®å†…éƒ¨ã«ã®ã¿ã‚¹ã‚³ãƒ¼ãƒ—ã‚’åˆ¶é™ã—ãŸã„å¤‰æ•°ã®åˆæœŸåŒ–ã¨ã„ã†ã®ã¯ã‚ˆãã‚ã‚‹ã“ã¨ã§ã€ C++ ã§ã‚‚ä¼¼ãŸã‚ˆã†ãªæ©Ÿèƒ½ãŒå°å…¥ã•ã‚Œã¾ã—ãŸã€‚

C++17 ã§ã®ã€Œ[æ¡ä»¶å¼ã¨åˆæœŸåŒ–ã‚’åˆ†é›¢](https://cpprefjp.github.io/lang/cpp17/selection_statements_with_initializer.html)ã€ã¨ã„ã†æ©Ÿèƒ½ã§ã™ã€‚ã“ã‚Œã¯ `for` æ–‡ã®ã‚ˆã†ã«åˆæœŸåŒ–æ–‡ã¨æ¡ä»¶å¼ã‚’ã‚»ãƒŸã‚³ãƒ­ãƒ³ã§åŒºåˆ‡ã‚‹ã“ã¨ãŒã§ãã‚‹ã¨ã„ã†æ©Ÿèƒ½ã§ã™ã€‚

```cpp
if (auto variable = init_variable(); variable.is_ok()) {
    // do something...
}
```

ã‚‚ã¡ã‚ã‚“ã€ Rust ã«æ¯”ã¹ã‚‹ã¨æ©Ÿèƒ½ã¯ã‹ãªã‚Šé™å®šçš„ã§ã™ã€‚ C++ ã«ã¯ãƒ‘ã‚¿ãƒ¼ãƒ³ãƒãƒƒãƒã¯ãªã„ã®ã§ã€ bool å€¤ã®å¼ã‚’è©•ä¾¡ã™ã‚‹ã“ã¨ã—ã‹ã§ãã¾ã›ã‚“ã—ã€ãƒã‚¹ãƒˆã™ã‚‹ã“ã¨ã‚‚ã§ãã¾ã›ã‚“ã€‚ãã‚Œã§ã‚‚ã€ã“ã®ã‚ˆã†ãªæ›¸ãæ–¹ãŒæ±‚ã‚ã‚‰ã‚Œã¦ã„ã‚‹ã“ã¨ã¯ç¢ºã‹ã§ã‚ã‚Šã€ Rust ã§ãã‚ŒãŒå¯èƒ½ã«ãªã£ãŸã®ã¯å–œã°ã—ã„ã“ã¨ã§ã™ã€‚

## ã¾ã¨ã‚

let chains æ§‹æ–‡ã¯å¯èª­æ€§ã‚’å‘ä¸Šã™ã‚‹ã‹ã‚‚ã—ã‚Œãªã„æœ‰ç”¨ãªæ©Ÿèƒ½ã§ã™ã€‚å¤ã„ã‚³ãƒ³ãƒ‘ã‚¤ãƒ©ã‚„ edition ã®äº’æ›æ€§ã‚’æ°—ã«ã™ã‚‹å¿…è¦ãŒãªã‘ã‚Œã°ä½¿ã£ã¦ã„ããŸã„æ©Ÿèƒ½ã§ã™ã€‚

ã¾ãŸã€è‡ªä½œè¨€èªã§ã‚‚ã“ã®ã‚ˆã†ãªæ§‹æ–‡ã¯å¯èƒ½ã«ã—ãŸã„ã¨ã“ã‚ã§ã™ã€‚
